name: 'Esegui deploy.sh per il Deploy su Cloud Run'

on:
  push:
    branches:
      - main
      - dev

env:
  PROJECT_ID: 'trading90'  # ID del progetto Google Cloud
  REGION: 'us-central1'  # Regione per Cloud Run e Artifact Registry
  SERVICE: 'trading-ai-service'  # Nome del servizio Cloud Run
  REPOSITORY: 'trading-ai-repo'  # Nome del repository Artifact Registry
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}  # Riconosce se √® `main` o `dev`

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Necessario per autenticazione Google Cloud

    steps:
      # üîπ 1Ô∏è‚É£ Scarica il codice del repository
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # üîπ 2Ô∏è‚É£ Autenticazione con Google Cloud
      - name: 'Autenticazione su Google Cloud'
        run: |
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" > $HOME/gcp-key.json
          gcloud auth activate-service-account --key-file=$HOME/gcp-key.json
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # üîπ 3Ô∏è‚É£ Concede permessi di esecuzione e avvia `deploy.sh`
      - name: 'Esegui deploy.sh'
        run: |
          chmod +x deploy.sh
          ./deploy.sh

 
