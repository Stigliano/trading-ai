name: 'Esegui deploy.sh per il Deploy su Cloud Run'

on:
  push:
    branches:
      - main
      - dev

env:
  PROJECT_ID: 'trading90'
  REGION: 'us-central1'
  SERVICE: 'trading-ai-service'
  REPOSITORY: 'trading-ai-repo'
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      # ğŸ”¹ 1ï¸âƒ£ Scarica il codice del repository
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # ğŸ”¹ 2ï¸âƒ£ Autenticazione su Google Cloud
      - name: 'Autenticazione su Google Cloud'
        run: |
          echo "ğŸ” Controllo presenza del segreto..."
          if [[ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]]; then
            echo "âŒ ERRORE: Il segreto GCP_SERVICE_ACCOUNT_KEY non Ã¨ stato impostato!"
            exit 1
          fi

          echo "ğŸ”‘ Scrittura chiave JSON..."
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 --decode > $HOME/gcp-key.json

          echo "ğŸ“‚ Verifica file JSON..."
          if [[ ! -s "$HOME/gcp-key.json" ]]; then
            echo "âŒ ERRORE: Il file JSON Ã¨ vuoto o invalido!"
            exit 1
          fi

          echo "ğŸ” Autenticazione GCloud..."
          gcloud auth activate-service-account --key-file=$HOME/gcp-key.json || { echo "âŒ Autenticazione fallita!"; exit 1; }

          echo "ğŸ”— Configurazione Docker per Artifact Registry..."
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev || { echo "âŒ ERRORE configurazione Docker!"; exit 1; }

      # ğŸ”¹ 3ï¸âƒ£ Setup GitHub CLI per deploy.sh
      - name: 'Setup GitHub CLI'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git

      # ğŸ”¹ 4ï¸âƒ£ Controlla e avvia deploy.sh
      - name: 'Verifica ed esegui deploy.sh'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“„ Controllo deploy.sh..."
          if [[ ! -f "deploy.sh" ]]; then
            echo "âŒ ERRORE: deploy.sh non trovato!"
            exit 1
          fi

          chmod +x deploy.sh
          echo "ğŸš€ Lancio deploy.sh..."
          ./deploy.sh || { echo "âŒ ERRORE: deploy.sh fallito!"; exit 1; }

      # ğŸ”¹ 4ï¸âƒ£ Conferma completamento
      - name: 'Conferma completamento'
        run: |
          echo "âœ… Il workflow Ã¨ stato completato con successo!"
