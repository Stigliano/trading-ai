name: 'Esegui deploy.sh per il Deploy su Cloud Run'

on:
  push:
    branches:
      - main
      - dev

env:
  PROJECT_ID: 'trading90'  # ID del progetto Google Cloud
  REGION: 'us-central1'  # Regione per Cloud Run e Artifact Registry
  SERVICE: 'trading-ai-service'  # Nome del servizio Cloud Run
  REPOSITORY: 'trading-ai-repo'  # Nome del repository Artifact Registry
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}  # Riconosce se è `main` o `dev`

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Necessario per autenticazione Google Cloud

    steps:
      # 🔹 1️⃣ Scarica il codice del repository
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # 🔹 2️⃣ Controllo e autenticazione su Google Cloud
      - name: 'Autenticazione su Google Cloud'
        run: |
          echo "🔍 Controllo che il segreto sia stato passato..."
          if [[ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]]; then
            echo "❌ ERRORE: Il segreto GCP_SERVICE_ACCOUNT_KEY non è stato impostato in GitHub Secrets!"
            exit 1
          fi

          echo "🔑 Scrittura della chiave JSON su file..."
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 --decode > $HOME/gcp-key.json

          echo "📂 Verifica che il file JSON sia stato creato correttamente..."
          if [[ ! -s "$HOME/gcp-key.json" ]]; then
            echo "❌ ERRORE: Il file JSON della chiave di servizio è vuoto o non valido!"
            exit 1
          fi

          echo "🔐 Autenticazione su Google Cloud..."
          gcloud auth activate-service-account --key-file=$HOME/gcp-key.json || { echo "❌ ERRORE: Autenticazione fallita!"; exit 1; }

          echo "🔗 Configurazione di Docker per Google Artifact Registry..."
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev || { echo "❌ ERRORE: Configurazione Docker fallita!"; exit 1; }

      # 🔹 3️⃣ Controllo esistenza di deploy.sh ed esecuzione
      - name: 'Verifica ed esegui deploy.sh'
        run: |
          echo "📂 Controllo se deploy.sh esiste..."
          if [[ ! -f "deploy.sh" ]]; then
            echo "❌ ERRORE: Il file deploy.sh non esiste nella directory!"
            exit 1
          fi

          echo "✅ Il file deploy.sh esiste. Concedo permessi di esecuzione..."
          chmod +x deploy.sh

          echo "🚀 Avvio deploy.sh..."
          ./deploy.sh || { echo "❌ ERRORE: Il deploy è fallito!"; exit 1; }

      # 🔹 4️⃣ Messaggio finale di successo
      - name: 'Conferma completamento'
        run: |
          echo "✅ Il workflow è stato completato con successo!"

