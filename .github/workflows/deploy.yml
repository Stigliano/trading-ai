name: 'Esegui deploy.sh per il Deploy su Cloud Run'

on:
  push:
    branches:
      - main
      - dev

env:
  PROJECT_ID: 'trading90'  # ID del progetto Google Cloud
  REGION: 'us-central1'  # Regione per Cloud Run e Artifact Registry
  SERVICE: 'trading-ai-service'  # Nome del servizio Cloud Run
  REPOSITORY: 'trading-ai-repo'  # Nome del repository Artifact Registry
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}  # Riconosce se Ã¨ `main` o `dev`

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Necessario per autenticazione Google Cloud

    steps:
      # ğŸ”¹ 1ï¸âƒ£ Scarica il codice del repository
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # ğŸ”¹ 2ï¸âƒ£ Controllo e autenticazione su Google Cloud
      - name: 'Autenticazione su Google Cloud'
        run: |
          echo "ğŸ” Controllo che il segreto sia stato passato..."
          if [[ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]]; then
            echo "âŒ ERRORE: Il segreto GCP_SERVICE_ACCOUNT_KEY non Ã¨ stato impostato in GitHub Secrets!"
            exit 1
          fi

          echo "ğŸ”‘ Scrittura della chiave JSON su file..."
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" | base64 --decode > $HOME/gcp-key.json

          echo "ğŸ“‚ Verifica che il file JSON sia stato creato correttamente..."
          if [[ ! -s "$HOME/gcp-key.json" ]]; then
            echo "âŒ ERRORE: Il file JSON della chiave di servizio Ã¨ vuoto o non valido!"
            exit 1
          fi

          echo "ğŸ” Autenticazione su Google Cloud..."
          gcloud auth activate-service-account --key-file=$HOME/gcp-key.json || { echo "âŒ ERRORE: Autenticazione fallita!"; exit 1; }

          echo "ğŸ”— Configurazione di Docker per Google Artifact Registry..."
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev || { echo "âŒ ERRORE: Configurazione Docker fallita!"; exit 1; }

      # ğŸ”¹ 3ï¸âƒ£ Controllo esistenza di deploy.sh ed esecuzione
      - name: 'Verifica ed esegui deploy.sh'
        run: |
          echo "ğŸ“‚ Controllo se deploy.sh esiste..."
          if [[ ! -f "deploy.sh" ]]; then
            echo "âŒ ERRORE: Il file deploy.sh non esiste nella directory!"
            exit 1
          fi

          echo "âœ… Il file deploy.sh esiste. Concedo permessi di esecuzione..."
          chmod +x deploy.sh

          echo "ğŸš€ Avvio deploy.sh..."
          ./deploy.sh || { echo "âŒ ERRORE: Il deploy Ã¨ fallito!"; exit 1; }

      # ğŸ”¹ 4ï¸âƒ£ Messaggio finale di successo
      - name: 'Conferma completamento'
        run: |
          echo "âœ… Il workflow Ã¨ stato completato con successo!"

